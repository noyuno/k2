version: "3"
services:
    nginx:
        image: steveltn/https-portal:1
        links:
            - php7
            - gitbucket
        ports:
            - 80:80
            - 443:443
        restart: always
        environment:
            STAGE: staging
            DOMAINS: 'noyu.cf, k2.noyu.cf, git.noyu.cf -> http://gitbucket:8080'
            SERVER_NAMES_HASH_BUCKET_SIZE: 64
        volumes:
            - ./data/cert:/var/lib/https-portal
            - ./nginx/conf:/var/lib/nginx-conf:ro
            - ./nginx/html:/var/www/html
            - owncloud:/var/www/owncloud
    php7:
        image: php:7-fpm-alpine
        restart: always
        volumes:
            - ./nginx/html:/var/www/html
    gitbucket:
        image: gitbucket/gitbucket
        restart: always
        volumes:
            - ./data/gitbucket:/gitbucket
        ports:
            - 8080:8080
        depends_on:
            - postgres
        environment:
            GITBUCKET_DB_URL: 'jdbc:postgresql://postgres/gitbucket'
            GITBUCKET_DB_USER: gitbucket
            GITBUCKET_DB_PASSWORD: ${POSTGRES_GITBUCKET_PASSWORD}
        
    postgres:
        image: postgres:11-alpine
        restart: always
        volumes:
            - ./data/postgres:/var/lib/postgresql/data
            - ./postgres/init:/docker-entrypoint-initdb.d
            - ./postgres/conf:/etc/postgresql
        environment:
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
            POSTGRES_GITBUCKET_PASSWORD: ${POSTGRES_GITBUCKET_PASSWORD}
            POSTGRES_OWNCLOUD_PASSWORD: ${POSTGRES_OWNCLOUD_PASSWORD}

    owncloud:
        image: owncloud/server:10.0
        links:
            - postgres
        environment:
            OWNCLOUD_DOMAIN: dir.noyu.cf
            OWNCLOUD_DB_TYPE: pgsql
            OWNCLOUD_DB_HOST: postgres
            OWNCLOUD_DB_NAME: owncloud
            OWNCLOUD_DB_USERNAME: owncloud
            OWNCLOUD_DB_PASSWORD: ${POSTGRES_OWNCLOUD_PASSWORD}
        volumes:
            - "./data/owncloud/data:/mnt/data"
            - owncloud:/var/www/owncloud

volumes:
    owncloud:


